# Day 42 + 43: RTK, RTK Query, Login, Register, React hook form

1. RTK

````javascript
import { createAsyncThunk } from "@reduxjs/toolkit";
import axios from "axios"; // Gi·∫£ s·ª≠ b·∫°n d√πng axios

// createAsyncThunk nh·∫≠n 2 tham s·ªë:
// 1. T√™n action: "t√™n_slice/t√™n_h√†nh_ƒë·ªông"
// 2. H√†m async th·ª±c thi vi·ªác g·ªçi API
export const getProductList = createAsyncThunk(
    "product/getList",
    async () => {
        const response = await axios.get("https://api.example.com/products");
        return response.data; // D·ªØ li·ªáu tr·∫£ v·ªÅ s·∫Ω v√†o action.payload
    }
); ```
````

### services/products/productService.js

-   L√† n∆°i g·ªçi b·∫•t ƒë·ªìng b·ªô api v√† tr·∫£ v·ªÅ d·ªØ li·ªáu. H√£y coi ph·∫ßn n√†y cu·ªëi c√πng l√† m·ªôt action bao g·ªìm: action.type v√† action.payload

```javascript
import { createSlice } from "@reduxjs/toolkit"
import { getProductList } from "@/services/products/productService"

const initialState = {
    list: [],
    isLoading: false,
    error: null,
}

export const productSlice = createSlice({
    name: "product",
    initialState,
    // D√†nh cho c√°c action ƒë·ªìng b·ªô (synchronous)
    reducers: {
        // v√≠ d·ª•: setSort: (state, action) => { ... }
        // Xu ly cac action khi ko phai xu ly bat dong bo
    },
    // D√†nh cho c√°c action b·∫•t ƒë·ªìng b·ªô (asynchronous) t·ª´ createAsyncThunk
    extraReducers: (builder) => {
        builder
            .addCase(getProductList.pending, (state) => {
                state.isLoading = true
                state.error = null
            })
            .addCase(getProductList.fulfilled, (state, action) => {
                state.isLoading = false
                state.list = action.payload // G√°n d·ªØ li·ªáu t·ª´ API v√†o state
            })
            .addCase(getProductList.rejected, (state, action) => {
                state.isLoading = false
                state.error = action.error.message
            })
    },
})

// Export reducer ƒë·ªÉ th√™m v√†o store
export default productSlice.reducer
```

### features/products/productSlice.js

-   T·∫°o ra m·ªôt Slice
-   extraReducer s·∫Ω x·ª≠ l√Ω c√°c action b·∫•t ƒë·ªìng b·ªô. ·ªû ƒë√¢y n√≥ s·∫Ω b·∫Øt tr·∫°ng th√°i d·ªØ li·ªáu ƒëang l√† g√¨: pending, fulfilled, rejected
-   reducer s·∫Ω x·ª≠ l√Ω c√°c action m√† kh√¥ng c·∫ßn x·ª≠ l√Ω b·∫•t ƒë·ªìng h·ªô

2. RTK Query

```javascript
import { createApi, fetchBaseQuery } from "@reduxjs/toolkit/query/react"

export const addressApi = createApi({
    reducerPath: "addressApi",
    baseQuery: fetchBaseQuery({ baseUrl: import.meta.env.VITE_BASE_API }),
    endpoints: (build) => ({
        getProvinces: build.query({
            query: () => `/address/provinces`,
        }),
    }),
})

export const { useGetProvincesQuery } = addressApi
```

### features/provinces

-   T·∫°o ra m·ªôt addressApi v√† t·∫•t c·∫£ m·ªçi th·ª© s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω trong n√≥
-   D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c tr·∫£ ra ·ªü useGetProvincesQuery

## C·∫•u h√¨nh store

1. ƒê·ªëi v·ªõi RTK

-   Ch·ªâ c·∫ßn th√™m reducer c·ªßa n√≥ v√†o RootReducer l√† xong

2. ƒê·ªëi v·ªõi RTK QUERY

-   C·∫ßn th√™m middleware c·ªßa n√≥ v√†o c√°i t·ªïng rootReducer

```javascript
import { combineReducers, configureStore } from "@reduxjs/toolkit"
import { persistStore, persistReducer } from "redux-persist"
import storage from "redux-persist/lib/storage" // defaults to localStorage for web

import { productSlice } from "@/features/products/productsSlice"
import { provincesApi } from "@/features/provinces"
import { setupListeners } from "@reduxjs/toolkit/query"
import { authSlice } from "@/features/auth"

const rootReducer = combineReducers({
    [productSlice.reducerPath]: productSlice.reducer,
    [provincesApi.reducerPath]: provincesApi.reducer,
    [authSlice.reducerPath]: authSlice.reducer,
})

const persistConfig = {
    key: "root",
    storage,
}

const persistedReducer = persistReducer(persistConfig, rootReducer)

const store = configureStore({
    reducer: persistedReducer,
    middleware: (getDefaultMiddlewares) => [
        ...getDefaultMiddlewares({
            serializableCheck: false,
        }),
        provincesApi.middleware,
    ],
})

const persistor = persistStore(store)

setupListeners(store.dispatch)

export { store, persistor }
```

=> Tr√™n ƒë√¢y l√† c·∫•u tr√∫c file store cho c·∫£ RTK v√† RTK query

=> ·ªû ƒë√¢y s·ª≠ d·ª•ng c·∫£ redux-persist

-   Gi√∫p l∆∞u tr·ªØ c√°c state c·ªßa Redux store v√†o m·ªôt n∆°i (localStorage v·ªõi web)
-   Gi√∫p l∆∞u tr·ªØ state l·∫°i khi f5 l·∫°i trang
-   persistor s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng ·ªü main

## C√°c lo·∫°i d·ªØ li·ªáu N√äN l∆∞u (Good to Persist) üëç

Gi·ªè h√†ng (Shopping Cart)

ƒê√¢y l√† tr∆∞·ªùng h·ª£p kinh ƒëi·ªÉn. Ng∆∞·ªùi d√πng th√™m 5 m√≥n ƒë·ªì v√†o gi·ªè, l·ª° tay F5, v√† th·∫•y gi·ªè h√†ng tr·ªëng r·ªóng. ƒê√¢y l√† m·ªôt tr·∫£i nghi·ªám r·∫•t t·ªá. redux-persist gi√∫p gi·ªØ l·∫°i gi·ªè h√†ng c·ªßa h·ªç.

C√†i ƒë·∫∑t ng∆∞·ªùi d√πng (User Preferences)

Giao di·ªán: Ch·∫ø ƒë·ªô S√°ng/T·ªëi (theme: 'dark').

Ng√¥n ng·ªØ: L·ª±a ch·ªçn ng√¥n ng·ªØ c·ªßa ng∆∞·ªùi d√πng (language: 'vi').

B·ªô l·ªçc: C√°c b·ªô l·ªçc m√† ng∆∞·ªùi d√πng ƒë√£ √°p d·ª•ng tr√™n m·ªôt trang danh s√°ch s·∫£n ph·∫©m (v√≠ d·ª•: "s·∫Øp x·∫øp theo gi√°", "ch·ªâ hi·ªÉn th·ªã h√†ng ch√≠nh h√£ng").

Tr·∫°ng th√°i Giao di·ªán (UI State)

V√≠ d·ª•: Tr·∫°ng th√°i ƒë√≥ng/m·ªü c·ªßa thanh sidebar (isSidebarCollapsed: true). N·∫øu ng∆∞·ªùi d√πng th√≠ch l√†m vi·ªác v·ªõi sidebar ƒë√£ thu g·ªçn, n√≥ n√™n gi·ªØ nguy√™n nh∆∞ v·∫≠y khi h·ªç quay l·∫°i.

Th√¥ng tin ng∆∞·ªùi d√πng c∆° b·∫£n (Non-sensitive User Info)

T√™n ng∆∞·ªùi d√πng, avatar, email (nh·ªØng th√¥ng tin c∆° b·∫£n d√πng ƒë·ªÉ hi·ªÉn th·ªã tr√™n header).

L∆ØU √ù: Tuy·ªát ƒë·ªëi kh√¥ng l∆∞u token theo c√°ch n√†y.

## Day 44. Refresh Token + Validate Form with Yup

1. Refresh Token

### Hi·ªÉu v·ªÅ Authentication v√† Authorization

-   Khi truy c·∫≠p t√†i nguy√™n ƒë∆∞·ª£c b·∫£o v·ªá(VD: Th√¥ng tin ng∆∞·ªùi d√πng ƒëang ƒëƒÉng nh·∫≠p)

-   Authentication: (X√°c th·ª±c ng∆∞·ªùi d√πng. Xem c√≥ ƒë√∫ng l√† b·∫°n hay kh√¥ng)
    -   G·ª≠i ƒëi th√¥ng tin ƒëƒÉng nh·∫≠p (Credentials)
    -   => Nh·∫≠n ƒë∆∞·ª£c token v√† l∆∞u l·∫°i (localStorage)
-   Truy c·∫≠p t√†i nguy√™n ƒë∆∞·ª£c b·∫£o v·ªá: (Ki·ªÉm tra quy·ªÅn truy c·∫≠p c·ªßa m√¨nh v√†o t√†i nguy√™n ƒë√≥. M√¨nh c√≥ ƒë∆∞·ª£c quy·ªÅn v√†o ƒë√≥ k)
    -   JWT h·ª£p l·ªá: 201 + data
    -   JWT kh√¥ng h·ª£p l·ªá: 401

### Hi·ªÉu v·ªÅ JWT: JSON WEB TOKEN

```
JWT l√† vi·∫øt t·∫Øt c·ªßa JSON Web Token.

ƒê√¢y l√† m·ªôt ti√™u chu·∫©n m·ªü (RFC 7519), ƒë∆∞·ª£c hi·ªÉu l√† m·ªôt "th·∫ª b√†i" ho·∫∑c m·ªôt "gi·∫•y th√¥ng h√†nh" k·ªπ thu·∫≠t s·ªë.

N√≥ ƒë∆∞·ª£c d√πng ƒë·ªÉ truy·ªÅn t·∫£i th√¥ng tin m·ªôt c√°ch an to√†n gi·ªØa c√°c b√™n (v√≠ d·ª•: gi·ªØa Front-end c·ªßa b·∫°n v√† Back-end) d∆∞·ªõi d·∫°ng m·ªôt ƒë·ªëi t∆∞·ª£ng JSON. Th√¥ng tin n√†y ƒë∆∞·ª£c tin c·∫≠y v√¨ n√≥ ƒë√£ ƒë∆∞·ª£c "k√Ω t√™n" b·∫±ng ch·ªØ k√Ω ƒëi·ªán t·ª≠.

Hi·ªÉu n√¥m na JWT l√† g√¨?
H√£y t∆∞·ªüng t∆∞·ª£ng JWT gi·ªëng nh∆∞ m·ªôt th·∫ª ID (CƒÉn c∆∞·ªõc) c√≥ ch·ªØ k√Ω v√† ƒë∆∞·ª£c √©p plastic.

Khi b·∫°n ƒëƒÉng nh·∫≠p (Authentication) v√†o m·ªôt h·ªá th·ªëng:

B·∫°n ƒë∆∞a email v√† password (gi·ªëng nh∆∞ ƒë∆∞a CMND).

Server ki·ªÉm tra, th·∫•y b·∫°n h·ª£p l·ªá, v√† c·∫•p cho b·∫°n m·ªôt c√°i JWT (gi·ªëng nh∆∞ ph√°t cho b·∫°n m·ªôt c√°i "th·∫ª kh√°ch" ƒë√£ ƒë∆∞·ª£c k√Ω t√™n v√† ƒë√≥ng d·∫•u).

Sau ƒë√≥, m·ªói khi b·∫°n mu·ªën truy c·∫≠p m·ªôt khu v·ª±c ƒë∆∞·ª£c b·∫£o v·ªá (v√≠ d·ª•: xem gi·ªè h√†ng, trang c√° nh√¢n):

B·∫°n ch·ªâ c·∫ßn ch√¨a c√°i "th·∫ª kh√°ch" (JWT) n√†y ra.

B·∫£o v·ªá (Server) kh√¥ng c·∫ßn ki·ªÉm tra l·∫°i CMND c·ªßa b·∫°n n·ªØa. H·ªç ch·ªâ c·∫ßn:

Nh√¨n xem con d·∫•u, ch·ªØ k√Ω (Signature) tr√™n th·∫ª c√≥ ph·∫£i l√† th·∫≠t kh√¥ng?

Th·∫ª n√†y c√≥ cho ph√©p b·∫°n v√†o khu v·ª±c n√†y kh√¥ng (Payload)?

N·∫øu th·∫ª h·ª£p l·ªá, h·ªç cho b·∫°n qua.

ƒê√¢y ch√≠nh l√† qu√° tr√¨nh Authorization (·ª¶y quy·ªÅn) m√† b·∫°n ƒë√£ h·ªèi tr∆∞·ªõc ƒë√≥.
```

## Refresh Token

-   Khi access_token h·∫øt h·∫°n, th√¨ r·∫•t nhi·ªÅu api s·∫Ω b·ªã l·ªói.
    Tuy nhi√™n ch·ªâ m·ªôt c√°i ƒë·∫ßu ti·ªÅn refresh token. V√† c√°c api kh√°c s·∫Ω ƒë·ª£i cho t·ªõi c√°i ƒë·∫ßu ti√™n refresh token xong v√† tr·∫£ v·ªÅ token m·ªõi v√† s·ª≠ d·ª•ng n√≥
    => ƒêo·∫°n code ho√†n ch·ªânh ƒë·ªÉ x·ª≠ l√Ω refresh token

```javascript
// ============================================
// PH·∫¶N 3: X·ª¨ L√ù L√ÄM M·ªöI TOKEN T·ª∞ ƒê·ªòNG
// ============================================

// Bi·∫øn theo d√µi xem c√≥ ƒëang l√†m m·ªõi token kh√¥ng
// Tr√°nh tr∆∞·ªùng h·ª£p nhi·ªÅu request c√πng l√∫c ƒë·ªÅu c·ªë g·∫Øng l√†m m·ªõi token
let isRefreshing = false

// H√†ng ƒë·ª£i ch·ª©a c√°c request b·ªã l·ªói 401 (h·∫øt h·∫°n token)
// Gi·ªëng nh∆∞ h√†ng ng∆∞·ªùi ch·ªù, khi c√≥ token m·ªõi s·∫Ω cho t·∫•t c·∫£ v√†o c√πng l√∫c
let failedQueue = []

// H√†m x·ª≠ l√Ω t·∫•t c·∫£ request ƒëang ch·ªù trong h√†ng ƒë·ª£i
const processQueue = (error) => {
    // Duy·ªát qua t·ª´ng request ƒëang ch·ªù
    failedQueue.forEach((prom) => {
        if (error) {
            // N·∫øu c√≥ l·ªói (l√†m m·ªõi token th·∫•t b·∫°i), th√¥ng b√°o l·ªói cho t·∫•t c·∫£
            prom.reject(error)
        } else {
            // N·∫øu th√†nh c√¥ng, cho ph√©p t·∫•t c·∫£ request th·ª≠ l·∫°i
            prom.resolve()
        }
    })

    // X√≥a s·∫°ch h√†ng ƒë·ª£i sau khi x·ª≠ l√Ω xong
    failedQueue = []
}

// H√†m th·ª±c hi·ªán vi·ªác l√†m m·ªõi token
const refreshToken = async () => {
    try {
        // G·ªçi API l√†m m·ªõi token b·∫±ng refreshToken hi·ªán c√≥
        const result = await axios.post(`${baseURL}/auth/refresh-token`, {
            refresh_token: localStorage.getItem("refreshToken"),
        })

        // L∆∞u c·∫∑p token m·ªõi v√†o localStorage
        localStorage.setItem("accessToken", result.data.data.access_token)
        localStorage.setItem("refreshToken", result.data.data.refresh_token)

        // Th√¥ng b√°o th√†nh c√¥ng cho t·∫•t c·∫£ request ƒëang ch·ªù
        processQueue(null)
    } catch (error) {
        // N·∫øu l√†m m·ªõi token th·∫•t b·∫°i, th√¥ng b√°o l·ªói cho t·∫•t c·∫£
        processQueue(error)
        throw error // N√©m l·ªói ƒë·ªÉ h√†m g·ªçi bi·∫øt vi·ªác l√†m m·ªõi th·∫•t b·∫°i
    }
}

// H√†m ƒëi·ªÅu ph·ªëi vi·ªác l·∫•y token m·ªõi
// ƒê·∫£m b·∫£o ch·ªâ c√≥ 1 request l√†m m·ªõi token t·∫°i m·ªôt th·ªùi ƒëi·ªÉm
const getNewToken = async () => {
    // N·∫øu ch∆∞a c√≥ ai ƒëang l√†m m·ªõi token
    if (!isRefreshing) {
        isRefreshing = true // ƒê√°nh d·∫•u l√† ƒëang l√†m m·ªõi
        await refreshToken() // Th·ª±c hi·ªán l√†m m·ªõi token
        isRefreshing = false // ƒê√°nh d·∫•u ho√†n th√†nh
        return
    }

    // N·∫øu ƒë√£ c√≥ request kh√°c ƒëang l√†m m·ªõi token
    // Th√¨ request n√†y s·∫Ω x·∫øp h√†ng ch·ªù ƒë·ª£i
    return new Promise((resolve, reject) => {
        // Th√™m v√†o h√†ng ƒë·ª£i, s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω khi token m·ªõi s·∫µn s√†ng
        failedQueue.push({ resolve, reject })
    })
}

// ============================================
// PH·∫¶N 4: X·ª¨ L√ù RESPONSE V√Ä L√ÄM M·ªöI TOKEN
// ============================================

// Interceptor (b·ªô ch·∫∑n) response: ch·∫°y SAU KHI nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ server
httpClient.interceptors.response.use(
    // N·∫øu response th√†nh c√¥ng (status 200-299), tr·∫£ v·ªÅ nguy√™n b·∫£n
    (response) => response,

    // N·∫øu c√≥ l·ªói, x·ª≠ l√Ω ·ªü ƒë√¢y
    async (error) => {
        // L∆∞u l·∫°i th√¥ng tin request g·ªëc ƒë·ªÉ c√≥ th·ªÉ th·ª≠ l·∫°i sau
        const originalRequest = error.config

        // Ki·ªÉm tra xem c√≥ n√™n l√†m m·ªõi token kh√¥ng:
        // - L·ªói 401 (Unauthorized - token h·∫øt h·∫°n)
        // - Request n√†y ch∆∞a t·ª´ng ƒë∆∞·ª£c th·ª≠ l·∫°i (_retry ch∆∞a set)
        const shouldRenewToken =
            error.response.status === 401 && !originalRequest._retry

        if (shouldRenewToken) {
            // ƒê√°nh d·∫•u request n√†y ƒë√£ ƒë∆∞·ª£c th·ª≠ l·∫°i, tr√°nh l·∫∑p v√¥ h·∫°n
            originalRequest._retry = true

            try {
                // L·∫•y token m·ªõi
                await getNewToken()

                // Th·ª≠ l·∫°i request ban ƒë·∫ßu v·ªõi token m·ªõi
                // httpClient s·∫Ω t·ª± ƒë·ªông g·∫Øn token m·ªõi v√†o (nh·ªù interceptor request)
                return httpClient(originalRequest)
            } catch (error) {
                // N·∫øu l√†m m·ªõi token th·∫•t b·∫°i, tr·∫£ v·ªÅ l·ªói
                // (Th∆∞·ªùng th√¨ s·∫Ω redirect v·ªÅ trang login)
                return Promise.reject(error)
            }
        }

        // N·∫øu kh√¥ng ph·∫£i l·ªói 401 ho·∫∑c ƒë√£ th·ª≠ l·∫°i r·ªìi, tr·∫£ v·ªÅ l·ªói b√¨nh th∆∞·ªùng
        return Promise.reject(error)
    }
)
```

## Day 45: Error Boundaries. Code Spliting. useReducer, Infinity Load

1. Error Boundaries

-   S·ª≠ d·ª•ng ƒë·ªÉ b·∫Øt l·ªói c√°c component con b√™n trong. Gi√∫p hi·ªÉn th·ªã ra m·ªôt UI t√πy ch·ªânh m√† ko ƒë·ªÉ tr∆∞·ªùng h·ª£p m√†n h√¨nh tr·∫Øng hi·ªán l√™n

Link: https://legacy.reactjs.org/docs/error-boundaries.html

-   => S·ª≠ d·ª•ng class compnent cho Error Boudaries
-   => B·ªçc n√≥ b√™n ngo√†i c√πng c·ªßa App trong main ƒë·ªÉ b·∫Øt l·ªói t·∫•t c·∫£

2. Code Spliting : Chia nh·ªè code. L√∫c n√†o truy c·∫≠p th√¨ m∆∞·ªõi t·∫£i. T·∫£i 1 l·∫ßn n√≥ s·∫Ω ƒëc cache l·∫°i v√† l·∫ßn sau truy c·∫≠p s·∫Ω ko b·ªã t·∫£i l·∫°i

### Khi n√†o n√™n s·ª≠ d·ª•ng:

-   Khi m·ªôt component qu√° l·ªõn > 100kb
-   Khi m·ªôt component ƒë∆∞·ª£c truy c·∫≠p l·∫ßn ƒë·∫ßu m·ªôt c√°ch tr·ª±c ti·∫øp (VD: Home, s·∫£n ph·∫©m, chi ti·∫øt sp, ...)

#### Note: Th√™m Suspense ƒë·ªÉ x·ª≠ l√Ω n√™√∫ tr∆∞·ªùng h·ª£p n√≥ t·∫£i l√¢u qu√° th√¨ th√™m loading.

V√≠ d·ª•: products s·ª≠ d·ª•ng code spliting. N·∫•u b·∫•m v√†o products => C·∫ßn t·∫£i file js cho page ƒë√≥. Trong th·ªùi gian t·∫£i n√™n th√™m loading

```javascript
<Suspense fallback={<div>Loading...</div>}>
    <App />
</Suspense>
```

## React portal

#### L∆∞u √Ω v·ªõi transform: Th·∫ª b√™n ngo√†i d√πng transform, th·∫ª b√™n trong n√≥ d√πng position: fixed => N√≥ s·∫Ω ph√° h·ªèng position fixed c·ªßa th·∫ª b√™n trong n√≥

```javascript
<body>
    <div id="root"></div>

    <div id="portal-root"></div>
</body>
```

-   S·ª≠ d·ª•ng m·ªôt portal-root ƒë·ªÉ b·ªçc t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ ƒë∆∞·ª£c ƒë∆∞a ra ngo√†i
    ![alt text](image.png)
-   C√°ch ƒë·ªÉ ch·ªâ t·∫°o m·ªôt l·∫ßn m·ªói khi m·ªü, n·∫øu ko n√≥ c·ª© li√™n t·ª•c th√™m khi m·ªü modal

## Infinity load
